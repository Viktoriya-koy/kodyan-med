<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha del Paciente - KodyanMED</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Estilos para pesta√±as */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--violeta-primario);
    }
    
    .tab-btn {
      padding: 12px 20px;
      background: var(--violeta-secundario);
      border: none;
      cursor: pointer;
      font-weight: 500;
      margin-right: 5px;
      border-radius: 8px 8px 0 0;
    }
    
    .tab-btn.active {
      background: var(--violeta-primario);
      color: var(--texto);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Odontograma */
      /* üëá AGREGAR ESTOS NUEVOS ESTILOS AL FINAL del <style> */
    /* Odontograma mejorado */
    .odontograma-container {
      text-align: center;
    }

    .arcada {
      margin: 20px 0;
    }

    .dientes-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }

    .diente-group {
      display: flex;
      gap: 3px;
    }

    .diente {
      width: 35px;
      height: 35px;
      border: 2px solid #B39DDB;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: white;
      font-weight: bold;
      transition: all 0.3s ease;
      position: relative;
    }

    .diente:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(179, 157, 219, 0.5);
    }

    .diente:hover::after {
      content: attr(data-diente);
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
    }

    /* Colores por tratamiento */
    .diente[data-tratamiento="caries"] {
      background: #FF6B6B;
      color: white;
    }

    .diente[data-tratamiento="obturacion"] {
      background: #4ECDC4;
      color: white;
    }

    .diente[data-tratamiento="corona"] {
      background: #FFE66D;
      color: #333;
    }

    .diente[data-tratamiento="endodoncia"] {
      background: #6A0572;
      color: white;
    }

    .diente[data-tratamiento="extraccion"] {
      background: #666;
      color: white;
      text-decoration: line-through;
    }

    .diente[data-tratamiento="sano"] {
      background: #EDE7F6;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1><i class="fas fa-user-injured"></i> Ficha del Paciente</h1>
      <a href="home.html" class="btn"><i class="fas fa-arrow-left"></i> Volver al Inicio</a>
    </header>

    <!-- Pesta√±as -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="1">
        <i class="fas fa-user"></i> Datos
      </button>
     <button class="tab-btn" data-tab="2">
    <i class="fas fa-tooth"></i> Odontograma
</button>
     <button class="tab-btn active" data-tab="3">
        <i class="fas fa-procedures"></i> Procedimientos
      </button>
      <button class="tab-btn active" data-tab="4">
        <i class="fas fa-pills"></i> Medicamentos
      </button>
    </div>

    <!-- Pesta√±a 1: Datos y Turnos -->
    <div class="tab-content active" id="tab-1">
      <!-- Datos Personales -->
      <div class="card">
        <h2><i class="fas fa-user"></i> Datos Personales</h2>
        <form id="form-editar-paciente">
          <div class="grid">
            <div class="form-group">
              <label><strong>Nombre:</strong></label>
              <input type="text" id="paciente-nombre" name="nombre" class="editable-field">
            </div>
            <div class="form-group">
              <label><strong>DNI:</strong></label>
              <input type="text" id="paciente-dni" name="dni" class="editable-field" readonly>
            </div>
            <div class="form-group">
              <label><strong>Tel√©fono:</strong></label>
              <input type="tel" id="paciente-telefono" name="telefono" class="editable-field">
            </div>
            <div class="form-group">
              <label><strong>Email:</strong></label>
              <input type="email" id="paciente-email" name="email" class="editable-field">
            </div>
            <div class="form-group">
              <label><strong>Obra Social:</strong></label>
              <input type="text" id="paciente-obra-social" name="obra_social" class="editable-field">
            </div>
            <div class="form-group">
              <label><strong>Historial M√©dico:</strong></label>
              <textarea id="paciente-historial" name="historial_medico" class="editable-field" rows="3"></textarea>
            </div>
          </div>
          <button type="submit" class="btn mt-20"><i class="fas fa-save"></i> Guardar Cambios</button>
        </form>
      </div>

      <!-- Turnos -->
      <div class="card">
        <h2><i class="fas fa-calendar"></i> Turnos</h2>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tabla-turnos">
            <tr><td colspan="3">Cargando turnos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

   <!-- Pesta√±a 2: Odontograma -->
<div class="tab-content" id="tab-2">
  <div class="card">
    <h2><i class="fas fa-tooth"></i> Odontograma</h2>
    
    <!-- Selector de tratamientos -->
    <div class="form-group">
      <label>Seleccionar tratamiento:</label>
      <select id="tipo-tratamiento" class="compact-input">
        <option value="caries">ü¶∑ Caries</option>
        <option value="obturacion">‚≠ê Obturaci√≥n (Arreglo)</option>
        <option value="corona">üëë Corona</option>
        <option value="endodoncia">üîç Endodoncia</option>
        <option value="extraccion">‚ùå Extracci√≥n</option>
        <option value="sano">‚úÖ Sano</option>
      </select>
    </div>

    <!-- Leyenda de tratamientos -->
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; padding: 10px; background: var(--violeta-secundario); border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #FF6B6B; border-radius: 2px;"></div>
        <small>Caries</small>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #4ECDC4; border-radius: 2px;"></div>
        <small>Obturaci√≥n</small>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #FFE66D; border-radius: 2px;"></div>
        <small>Corona</small>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #6A0572; border-radius: 2px;"></div>
        <small>Endodoncia</small>
      </div>
      <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #666; border-radius: 2px;"></div>
        <small>Extra√≠do</small>
      </div>
    </div>

    <!-- Odontograma visual con representaci√≥n gr√°fica -->
    <div class="odontograma-container">
      <!-- Arcada Superior -->
      <div class="arcada" style="margin-bottom: 30px;">
        <h4>Arcada Superior</h4>
        <div class="dientes-row">
          <!-- Dientes derechos (18-11) -->
          <div class="diente-group">
            <div class="diente" data-diente="18" title="Molar 3¬∞ (18)">‚óª</div>
            <div class="diente" data-diente="17" title="Molar 2¬∞ (17)">‚óª</div>
            <div class="diente" data-diente="16" title="Molar 1¬∞ (16)">‚óª</div>
            <div class="diente" data-diente="15" title="Premolar 2¬∞ (15)">‚óª</div>
            <div class="diente" data-diente="14" title="Premolar 1¬∞ (14)">‚óª</div>
            <div class="diente" data-diente="13" title="Canino (13)">‚óª</div>
            <div class="diente" data-diente="12" title="Incisivo Lateral (12)">‚óª</div>
            <div class="diente" data-diente="11" title="Incisivo Central (11)">‚óª</div>
          </div>
          
          <!-- Dientes izquierdos (21-28) -->
          <div class="diente-group">
            <div class="diente" data-diente="21" title="Incisivo Central (21)">‚óª</div>
            <div class="diente" data-diente="22" title="Incisivo Lateral (22)">‚óª</div>
            <div class="diente" data-diente="23" title="Canino (23)">‚óª</div>
            <div class="diente" data-diente="24" title="Premolar 1¬∞ (24)">‚óª</div>
            <div class="diente" data-diente="25" title="Premolar 2¬∞ (25)">‚óª</div>
            <div class="diente" data-diente="26" title="Molar 1¬∞ (26)">‚óª</div>
            <div class="diente" data-diente="27" title="Molar 2¬∞ (27)">‚óª</div>
            <div class="diente" data-diente="28" title="Molar 3¬∞ (28)">‚óª</div>
          </div>
        </div>
      </div>

      <!-- Arcada Inferior -->
      <div class="arcada">
        <h4>Arcada Inferior</h4>
        <div class="dientes-row">
          <!-- Dientes izquierdos (31-38) -->
          <div class="diente-group">
            <div class="diente" data-diente="38" title="Molar 3¬∞ (38)">‚óª</div>
            <div class="diente" data-diente="37" title="Molar 2¬∞ (37)">‚óª</div>
            <div class="diente" data-diente="36" title="Molar 1¬∞ (36)">‚óª</div>
            <div class="diente" data-diente="35" title="Premolar 2¬∞ (35)">‚óª</div>
            <div class="diente" data-diente="34" title="Premolar 1¬∞ (34)">‚óª</div>
            <div class="diente" data-diente="33" title="Canino (33)">‚óª</div>
            <div class="diente" data-diente="32" title="Incisivo Lateral (32)">‚óª</div>
            <div class="diente" data-diente="31" title="Incisivo Central (31)">‚óª</div>
          </div>
          
          <!-- Dientes derechos (41-48) -->
          <div class="diente-group">
            <div class="diente" data-diente="41" title="Incisivo Central (41)">‚óª</div>
            <div class="diente" data-diente="42" title="Incisivo Lateral (42)">‚óª</div>
            <div class="diente" data-diente="43" title="Canino (43)">‚óª</div>
            <div class="diente" data-diente="44" title="Premolar 1¬∞ (44)">‚óª</div>
            <div class="diente" data-diente="45" title="Premolar 2¬∞ (45)">‚óª</div>
            <div class="diente" data-diente="46" title="Molar 1¬∞ (46)">‚óª</div>
            <div class="diente" data-diente="47" title="Molar 2¬∞ (47)">‚óª</div>
            <div class="diente" data-diente="48" title="Molar 3¬∞ (48)">‚óª</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Historial de tratamientos -->
    <h3 style="margin-top: 30px;"><i class="fas fa-history"></i> Historial de Tratamientos</h3>
    <table>
      <thead>
        <tr>
          <th>Diente</th>
          <th>Nombre</th>
          <th>Tratamiento</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="tabla-tratamientos">
        <tr><td colspan="4">No hay tratamientos registrados</td></tr>
      </tbody>
    </table>
  </div>
</div>
<!-- Formulario para detalles del tratamiento -->
<div id="formulario-tratamiento" style="display: none; margin: 20px 0; padding: 15px; background: var(--violeta-secundario); border-radius: 8px;">
  <h4>Detalles del tratamiento en <span id="diente-seleccionado"></span></h4>
  
  <div class="form-group">
    <label>Tratamiento aplicado:</label>
    <select id="tratamiento-detalle" class="compact-input">
      <option value="caries">ü¶∑ Caries</option>
      <option value="obturacion">‚≠ê Obturaci√≥n (Arreglo)</option>
      <option value="corona">üëë Corona</option>
      <option value="endodoncia">üîç Endodoncia</option>
      <option value="extraccion">‚ùå Extracci√≥n</option>
      <option value="sano">‚úÖ Sano</option>
    </select>
  </div>

  <div class="form-group">
    <label>Fecha del tratamiento:</label>
    <input type="date" id="fecha-tratamiento" class="compact-input" value="<?php echo date('Y-m-d'); ?>">
  </div>

  <div class="form-group">
    <label>Observaciones:</label>
    <textarea id="observaciones-tratamiento" class="compact-input" rows="3" placeholder="Detalles del tratamiento realizado..."></textarea>
  </div>

  <div class="form-group">
    <label>Subir imagen (opcional):</label>
    <input type="file" id="imagen-tratamiento" accept="image/*">
  </div>

  <div style="display: flex; gap: 10px;">
    <button type="button" class="btn" onclick="guardarTratamiento()">
      <i class="fas fa-save"></i> Guardar Tratamiento
    </button>
    <button type="button" class="btn" style="background: #ff4757;" onclick="cancelarTratamiento()">
      <i class="fas fa-times"></i> Cancelar
    </button>
  </div>
</div>
    <!-- Pesta√±a 3: Procedimientos -->
    <div class="tab-content" id="tab-3">
      <!-- Procedimientos Realizados -->
      <div class="card">
        <h2><i class="fas fa-procedures"></i> Procedimientos Realizados</h2>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Procedimiento</th>
              <th>Detalles</th>
              <th>Imagen</th>
            </tr>
          </thead>
          <tbody id="tabla-procedimientos">
            <tr><td colspan="4">Cargando procedimientos...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Formulario para agregar procedimiento -->
      <div class="card">
        <h2><i class="fas fa-plus-circle"></i> Agregar Procedimiento</h2>
        <form id="form-procedimiento">
          <div class="form-group">
            <label>Fecha</label>
            <input type="date" id="fecha-procedimiento" required>
          </div>
          <div class="form-group">
            <label>Procedimiento</label>
            <input type="text" id="tipo-procedimiento" required>
          </div>
          <div class="form-group">
            <label>Detalles</label>
            <textarea id="detalles-procedimiento"></textarea>
          </div>
          <div class="form-group">
            <label>Subir imagen (radiograf√≠a/foto)</label>
            <input type="file" id="imagen-procedimiento">
          </div>
          <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Procedimiento</button>
        </form>
      </div>
    </div>

    <!-- Pesta√±a 4: Medicamentos -->
    <div class="tab-content" id="tab-4">
      <!-- Medicamentos -->
      <div class="card">
        <h2><i class="fas fa-pills"></i> Medicamentos</h2>
        <table>
          <thead>
            <tr>
              <th>Medicamento</th>
              <th>Dosis</th>
              <th>Frecuencia</th>
              <th>Inicio</th>
              <th>Fin</th>
            </tr>
          </thead>
          <tbody id="tabla-medicamentos">
            <tr><td colspan="5">Cargando medicamentos...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Formulario para agregar medicamento -->
      <div class="card">
        <h2><i class="fas fa-plus-circle"></i> Agregar Medicamento</h2>
        <form id="form-medicamento">
          <div class="form-group">
            <label>Medicamento</label>
            <input type="text" id="nombre-medicamento" required>
          </div>
          <div class="form-group">
            <label>Dosis</label>
            <input type="text" id="dosis-medicamento" placeholder="Ej: 500mg" required>
          </div>
          <div class="form-group">
            <label>Frecuencia</label>
            <input type="text" id="frecuencia-medicamento" placeholder="Ej: Cada 8 horas" required>
          </div>
          <div class="form-group">
            <label>Fecha inicio</label>
            <input type="date" id="inicio-medicamento" required>
          </div>
          <div class="form-group">
            <label>Fecha fin (opcional)</label>
            <input type="date" id="fin-medicamento">
          </div>
          <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Medicamento</button>
        </form>
      </div>
    </div>
  </div>

  <script src="js/supabase.js"></script>
  <script src="js/database.js"></script>
  <script src="js/app.js"></script>
  <script src="js/paciente.js"></script>
  
<script>
// Funci√≥n para cambiar pesta√±as
function cambiarPesta√±a(numero) {
    // Ocultar todas las pesta√±as
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar la pesta√±a seleccionada
    document.getElementById('tab-' + numero).classList.add('active');
    
    // Actualizar botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn')[numero - 1].classList.add('active');
}

// Variables globales
let dienteActual = null;

// Cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Configurar event listeners para las pesta√±as
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const numero = this.getAttribute('data-tab');
            cambiarPesta√±a(numero);
        });
    });

    // Configurar odontograma
    const dientes = document.querySelectorAll('.diente');
    dientes.forEach(diente => {
        diente.addEventListener('click', function() {
            dienteActual = this.getAttribute('data-diente');
            const nombreDiente = obtenerNombreDiente(dienteActual);
            
            // Mostrar formulario
            document.getElementById('formulario-tratamiento').style.display = 'block';
            document.getElementById('diente-seleccionado').textContent = `Diente ${dienteActual} - ${nombreDiente}`;
            
            // Scroll al formulario
            document.getElementById('formulario-tratamiento').scrollIntoView({ 
                behavior: 'smooth' 
            });
        });
    });
});

function obtenerNombreDiente(numero) {
    const nombresDientes = {
        '11': 'Incisivo Central Superior Derecho', '12': 'Incisivo Lateral Superior Derecho',
        '13': 'Canino Superior Derecho', '14': 'Primer Premolar Superior Derecho',
        '15': 'Segundo Premolar Superior Derecho', '16': 'Primer Molar Superior Derecho',
        '17': 'Segundo Molar Superior Derecho', '18': 'Tercer Molar Superior Derecho',
        '21': 'Incisivo Central Superior Izquierdo', '22': 'Incisivo Lateral Superior Izquierdo',
        '23': 'Canino Superior Izquierdo', '24': 'Primer Premolar Superior Izquierdo',
        '25': 'Segundo Premolar Superior Izquierdo', '26': 'Primer Molar Superior Izquierdo',
        '27': 'Segundo Molar Superior Izquierdo', '28': 'Tercer Molar Superior Izquierdo',
        '31': 'Incisivo Central Inferior Izquierdo', '32': 'Incisivo Lateral Inferior Izquierdo',
        '33': 'Canino Inferior Izquierdo', '34': 'Primer Premolar Inferior Izquierdo',
        '35': 'Segundo Premolar Inferior Izquierdo', '36': 'Primer Molar Inferior Izquierdo',
        '37': 'Segundo Molar Inferior Izquierdo', '38': 'Tercer Molar Inferior Izquierdo',
        '41': 'Incisivo Central Inferior Derecho', '42': 'Incisivo Lateral Inferior Derecho',
        '43': 'Canino Inferior Derecho', '44': 'Primer Premolar Inferior Derecho',
        '45': 'Segundo Premolar Inferior Derecho', '46': 'Primer Molar Inferior Derecho',
        '47': 'Segundo Molar Inferior Derecho', '48': 'Tercer Molar Inferior Derecho'
    };
    return nombresDientes[numero] || `Diente ${numero}`;
}

async function guardarTratamiento() {
    if (!dienteActual) return;

    const tratamiento = document.getElementById('tratamiento-detalle').value;
    const fecha = document.getElementById('fecha-tratamiento').value;
    const observaciones = document.getElementById('observaciones-tratamiento').value;
    
    // Valor por defecto para fecha si est√° vac√≠a
    const fechaTratamiento = fecha || new Date().toISOString().split('T')[0];
    
    try {
        // 1. Guardar en Supabase
        const { error } = await supabase
            .from('tratamientos_dentales')
            .insert([{
                dni_paciente: obtenerDNIPaciente(),
                diente: dienteActual,
                tratamiento: tratamiento,
                fecha: fechaTratamiento,
                observaciones: observaciones,
                profesional_id: await obtenerProfesionalId()
            }]);

        if (error) throw error;

        // 2. Actualizar visualizaci√≥n del diente
        const dienteElement = document.querySelector(`.diente[data-diente="${dienteActual}"]`);
        if (dienteElement) {
            dienteElement.removeAttribute('data-tratamiento');
            if (tratamiento !== 'sano') {
                dienteElement.setAttribute('data-tratamiento', tratamiento);
            }
        }

        // 3. Actualizar historial
        actualizarHistorialTratamientos(dienteActual, tratamiento, fechaTratamiento);

        // 4. Limpiar y ocultar formulario
        cancelarTratamiento();

        alert('‚úÖ Tratamiento guardado correctamente');

    } catch (error) {
        console.error('Error guardando tratamiento:', error);
        alert('‚ùå Error al guardar: ' + error.message);
    }
}

function cancelarTratamiento() {
    document.getElementById('formulario-tratamiento').style.display = 'none';
    document.getElementById('observaciones-tratamiento').value = '';
    dienteActual = null;
}

function actualizarHistorialTratamientos(diente, tratamiento, fecha) {
    const tratamientos = {
        'caries': 'Caries', 
        'obturacion': 'Obturaci√≥n', 
        'corona': 'Corona',
        'endodoncia': 'Endodoncia', 
        'extraccion': 'Extracci√≥n', 
        'sano': 'Sano'
    };
    
    const tabla = document.getElementById('tabla-tratamientos');
    if (!tabla) return;
    
    const nuevaFila = `
        <tr>
            <td><strong>${diente}</strong></td>
            <td>${obtenerNombreDiente(diente)}</td>
            <td>${tratamientos[tratamiento] || tratamiento}</td>
            <td>${new Date(fecha).toLocaleDateString('es-AR')}</td>
        </tr>
    `;
    
    if (tabla.innerHTML.includes('No hay tratamientos')) {
        tabla.innerHTML = nuevaFila;
    } else {
        tabla.innerHTML = nuevaFila + tabla.innerHTML;
    }
}

// Funci√≥n auxiliar para obtener DNI del paciente
function obtenerDNIPaciente() {
    const dniInput = document.getElementById('paciente-dni');
    return dniInput ? dniInput.value : 'unknown';
}

// Funci√≥n auxiliar para obtener ID del profesional
async function obtenerProfesionalId() {
    try {
        const { data: { session } } = await supabase.auth.getSession();
        return session?.user?.id || 'demo';
    } catch (error) {
        console.error('Error obteniendo sesi√≥n:', error);
        return 'demo';
    }
}
</script>
</body>
</html>
